---
title: "Import"
output:
  html_document:
    df_print: paged
---

Dnes sa pokúsime dosta» do R nejaké dáta a upravi» ich do pou¾iteµnej podoby.

## Dáta pre R

R doká¾e naèíta» dáta z najrozmanitej¹ích zdrojov.

My sa budeme zaobera» troma:
- textové súbory
- MS Excel
- JSON (JavaScript Object Notation)


### RT-PCR

Pou¾ijeme dáta z analýzy expresie génov redoxnej ochrany.

Pod expresiou rozumieme rýchlos», s akou sa syntetizuje daný gén. Meriame ju pomocou real-time PCR (tie¾ qPCR, kvantitatívna PCR) ako mno¾stvo mRNA obsahujúcej sekvenciu príslu¹ného génu (alebo jej charakteristickú èas»)

Veµmi struène o RT-PCR (podrobnej¹ie napríklad tu: http://labguide.cz/metody/real-time-pcr/):

* Oznaèíme ¹pecifickými syntetickými markermi sekvenciu pre daný gén.

* Poèas opakujúcich sa teplotných cyklov dochádza k multiplikácii tohoto úseku.

* Nárast je spoèiatku exponenciálny, potom prechádza do saturácie, ako postupne ubúda substrát pre syntézu nových replík

* Závislos» mno¾stva syntetizovanej DNA od èasu má teda esovitý charakter.

* Dosiahnuté plató nesúvisí s poèiatoèným mno¾stvom ¹tudovanej sekvencie vo vzorke.

* Mierou mno¹tva je cyklus, v ktorom exponenciálny nárast prejde do lineárneho.

![Multiplikácia vzorky v Real-time PCR](..\\pics\\real-time-curve.jpg)


## Import textových dát

Na dátach z RT-PCR si vyskú¹ame import, a to z textového formátu a z Excelu.

![©truktúra superoxid dismutázy 3](https://upload.wikimedia.org/wikipedia/commons/thumb/e/e8/SOD3_2JLP.png/330px-SOD3_2JLP.png)

Textové dátové súbory pre

* gén superoxid dismutázy 3 (SOD3, extracelulárna tetramérna superoxid dismutáza, https://en.wikipedia.org/wiki/Superoxide_dismutase)

* gén receptoru angiotenzínu II 1. typu (AT1R, https://en.wikipedia.org/wiki/Angiotensin_II_receptor_type_1)

* gén hém oxygenázy 1 (HI-1, https://en.wikipedia.org/wiki/Heme_oxygenase)

* gén proteínu p22phox, èo je podjednotka NADPH oxidázy (p22, https://en.wikipedia.org/wiki/P22phox)

* a pre referenèný, *housekeeper* gén glyceraldehyd-3-fosfát dehydrogenázu (GAPDH, https://en.wikipedia.org/wiki/Glyceraldehyde_3-phosphate_dehydrogenase)

nájdete v repozitári kurzu, https://github.com/PKvasnick/RTutorial/tree/master/data.

![Dáta v GitHub repozitári kurzu](../pics/github_data.png)
Dátové súbory si nemusíte s»ahova», mô¾ete ich importova» priamo z GitHubu.

Pou¾ijeme balíky `tidyverse`, tak ako v naposledy.

```{r}
library(tidyverse)
```

### Asistované kódovanie

Pre naèítanie súboru vyu¾ijeme nástroj na import dát, ktorý ponúka *RStudio*. Tento nástroj nám toti¾ pomô¾e doladi» parametre pre naèítanie a získa» kód, ktorým sa naèítanie vykoná.

![Vyberte File/Import data/From Text (readr)](../pics/rstudio_select_import.png)

Otvorí sa nástroj pre import.

![Nástroj na import dát v RStudiu](../pics/rstudio_inside_import.png)

Zadajme adresu súboru v repozitári na GitHube. Aby sme získali správnu adresu, musíme prejs» na súbor a zvoli» raw zobrazenie:

![Vyberte po¾adovaný dátový súbor a kliknite na Raw vpravo na ¹edej li¹te](../pics/github_select_data_file.jpg)

Teraz skopírujte adresu z adresového riadku prehliadaèa a vlo¾te ju do príslu¹ného poµa v importéri. Stlaète `Update` vpravo od poµa a uvidíte náhµad dát.

![Vidíme náhµad importovaných dát a musíme doladi» nastavenia, aby import prebehol správne.](../pics/rstudio_import_preview.png)

Hneï vidíme, ¾e dáta sa nerozdelili do ståpcov. Je to preto, ¾e máme zle nastavený oddeµovací znak. Nastavte v poli `Delimiter` na `Tab` a v¹etko sa napraví. Takisto potrebujeme zada» názov dát, preto¾e budeme importova» ïal¹iu pre referenciu (GAPDH).

![Úprava nastavení importu](../pics/rstudio_import_adjust.png)

Kým kliknete na `Import`, v¹imnite si, ¾e v poli vpravo dolu máme kód, ktorý sa vykoná. Ten si mô¾eme okopírova» do svojho skriptu a pritom sa pouèi», ako taký príkaz vyzerá.

```{r}
sod3.data <- read_delim("https://raw.githubusercontent.com/PKvasnick/RTutorial/master/data/sod3_full.dat",
    "\t", escape_double = FALSE, trim_ws = TRUE)
```

```{r}
View(sod3.data)
```


a ako sna¾iví úèastníci kurzu samozrejme hneï spú¹»ate `help(read_delim)`, resp. `?read_delim`, aby ste sa dozvedeli viac.

__Úloha__: Overte, èo robí príkaz `View(sod3.data)`.
__Úloha__: Skontrolujte, ¾e naèítanie prebehlo správne.

## Úprava dát

```{r}
gapdh.data <- read_delim("https://raw.githubusercontent.com/PKvasnick/RTutorial/master/data/gapdh_full.dat",
    "\t", escape_double = FALSE, trim_ws = TRUE)
print(gapdh.data)
```

Najskôr musíme dáta normalizova». Sú dve veci, ktoré mô¾ete spravi»:

* "ratio estimator" - vzia» hodnoty pre ka¾dú skupinu v skúmanom géne a referencii, a pou¾i» vz»ahy pre podiel dvoch náhodných premenných (https://en.wikipedia.org/wiki/Ratio_estimator'. To je korektné a presné, ale pomerne »a¾ko sa s tým pracuje pri viacerých génoch.

* pristúpi» k problému ako k regeresii s chybami v nezávislej premennej, a hµada» smernice priamok $$C_{gén}\sim C_{ref}$$ a ich chyby. Rovnaký problém ako predchádzajúci prístup.

* Pou¾i» logaritmus podielu koncentrácie pre gén a pre referenciu. $$\log(C/C_{ref})$$ Dobrá varianta, logaritmus stabilizuje rozdelenie dát a mô¾eme veselo pou¾íva» analýzu rozptylu. Nie tak exaktne presné ako predchádzajúce varianty, ale omnoho praktickej¹ie.

```{r}
sod3.data$Cref <- gapdh.data$C
sod3.data$LogRat <- log10(sod3.data$C / sod3.data$Cref)
print(sod3.data)
```

No a teraz si poïme nakresli», èo máme, a hneï sa aj nauèíme zopár nových __geomov__.

```{r}
ggplot(data = sod3.data) +
  geom_boxplot(mapping = aes(x = Group, y = LogRat, color = Group)) +
  geom_jitter(mapping = aes(x = Group, y = LogRat, color = Group))
```

Pou¾ili sme dve zobrazenia tých istých dát, ako vidno, staèí na to __+__ a prida» ïal¹iu vrstvu.

1. `geom_boxplot` nakreslí známe krabicové zobrazenie:

  - obdå¾nik ukazuje medzikvartilovú vzdialenos» (25% a 75% kvantil)
  - prieèka ukazuje medián
  - no¾ièky siahajú od hraníc krabice k bodom vzdialeným menej ako 1,5-násobok medzikvartilovej vzdialenosti
  - osobitne sú vynesené hodnoty mimo tento rozsah.

2. `geom_jitter` náhodne vynesie body do pruhu pre danú skupinu.

### Faktory a referenèné úrovne

Predchádzajúci graf je síce pekný, ale má vá¾nu chybu. Chceli by sme ma» kontrolu vµavo a nie uprostred. Tá chzba sa uká¾e e¹te výraznej¹ie, keï sa pokúsime urobi» analýzu rozptylu:

```{r}
sod3.fit <- lm(LogRat ~ Group, data = sod3.data)
summary(sod3.fit)
```

Aj tu pochopite2ne chceme ma» kontrolu ako referenènú hladinu, preto¾e inak výsledky nie sú dobre pou¾iteµné.

Pozrime sa na polia `Group` a `Location`.

```{r}
print(sod3.data$Location)
print(sod3.data$Group)
```

Ako vidno, tieto polia vlastne neobsahujú informatívne znakové re»azce, ale obsahujú informáciu o dvoch klasifikáciách:

* __zvierati__ / vzorke. Oznaèenia sú v skutoènosti oznaèenia na meracej platnièke, ale je dôle¾ité vedie», ktoré merania spolu súvisia.

* __terapeutickej skupine__.

Tieto ståpce musíme premeni» na __faktory__.

```{r}
sod3.data$Location = as.factor(sod3.data$Location)
sod3.data$Group = as.factor(sod3.data$Group)
sod3.data
```

A u ståpca `Group` chceme nastavit kontrolu ako referenènú hladinu.

```{r}
sod3.data$Group = relevel(sod3.data$Group, ref = "KONTROLA")
print(sod3.data$Group)
```

Teraz si mô¾eme znova nakrelis» graf

```{r}
ggplot(data = sod3.data) +
  geom_boxplot(mapping = aes(x = Group, y = LogRat, color = Group)) +
  geom_jitter(mapping = aes(x = Group, y = LogRat, color = Group))
```

a urobi» analýzu rozptylu:

```{r}
sod3.fit <- lm(LogRat ~ Group, data = sod3.data)
summary(sod3.fit)
```

Ako teraz zistíme, ktoré z rozdielov medzi skupinami sú ¹tatisticky významné?
Mo¾ností je niekoµko, my pou¾ijeme systematickú variantu s balíèkom `multcomp`:

```{r}
# if(!require(multcomp)){install.packages("multcomp")}
```

Aby sme `R` vysvetlili, aké porovnania chceme urobi», musíme vytvori» *maticu kontrastov*. Pri tom sa zase nauèíme nieèo z R:

```{r}
Input = ("
Contrast.Name KONTROLA  7-NI  L-NAME
 7-NI_vs_CTRL   -1       1       0
 L-NAME_vs_CTRL -1       0       1
 L-NAME_vs_7-NI  0      -1       1
")
cmat = as.matrix(read.table(textConnection(Input), header=TRUE, row.names=1))
cmat

library(multcomp)

G <- glht(sod3.fit, linfct = mcp(Group = cmat))

summary(G, test=adjusted("single-step"))
```

Ako vám prezradí `help(glht)`, máte k dispozícii niekoµko mo¾ností ako prispôsobi» hladinu významnosti: "none", "single-step", "Shaffer", "Westfall", "free", "holm", "hochberg", "hommel", "bonferroni", "BH", "BY", "fdr".

Ktorú zvoli», je bohu¾iaµ mimo rámca tohoto kurzu. Preto¾e my máme iba tri porovnania, staèí nám ¹tandardné nastavenie. Skúste e¹te Shafferov test, a ak dostanete podobné výsledky, bude najskôr v¹etko v poriadku.

__Úloha__ V repozitári nájdete dáta o mamografickej ¹túdii z http://datahub.io/JohnSnowLabs/mammography-data-from-breast-cancer-surveillance-consortium. Vymyslite, èo by sa s nimi dalo urobi». Preskúmajte naèítanie dát cez JSON objekt, ako je popísané na stránke.


## Import dát z Excelu

V adresári `data` v repozitári kurzu nájdete súbor `Expresie_dospele.xlsx`.

__Úloha__: Pou¾ite rovnaký postup ako pri textových dátach: Vyu¾ite nástroj pre import dát v Rstudiu na vytvorenie kódu pre import dát z Excelu a pou¾ite ho v notebooku.
